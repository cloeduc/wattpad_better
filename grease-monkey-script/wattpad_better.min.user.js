// ==UserScript==
// @name         Better WattPad
// @namespace    http://cestdoncvrai.fr/
// @version      0.7
// @author       Alinoee
// @match        https://www.wattpad.com/*
// @grant        none
// ==/UserScript==

/*
  START CONFIGURATION
*/
var bw_ENABLE_JUSTIFY = true; // true -> justifie text on fiction // false -> default comportment
var bw_ENABLE_SELECT = true; // true -> enable selection on fiction // false -> default comportment
var bw_ENABLE_COMMENT_IN_BIG = true; // true -> auto-resize comment and other text fields // false -> default comportment (use scroll bar)
var bw_ENABLE_AUTO_LINK = true; // true -> make all links on fiction clikable // false -> default comportment
var bw_INDENT = 0; // 0 : no indentation (default comportement) // 1 : 1em indentation // 2 : 2em indentation ...etc.
var bw_ENABLE_BROADCAT_AUTO = true; // true -> check "notify my user" // false -> default comportment
var bw_ENABLE_LOCAL_STORAGE_GESTION=true;  // true display button to update notifications // false -> no button... no notifications !
var bw_ENABLE_ADDITIONNAL_LINK=true;  // true display some additionals links to navigate on fiction

/*
  START CORE - DO NOT MODIFIE
*/
// Addlibrary
!function(e,t){if("function"==typeof define&&define.amd)define(["exports","module"],t);else if("undefined"!=typeof exports&&"undefined"!=typeof module)t(exports,module);else{var n={exports:{}};t(n.exports,n),e.autosize=n.exports}}(this,function(e,t){"use strict";function n(e){function t(){var t=window.getComputedStyle(e,null);c=t.overflowY,"vertical"===t.resize?e.style.resize="none":"both"===t.resize&&(e.style.resize="horizontal"),f="content-box"===t.boxSizing?-(parseFloat(t.paddingTop)+parseFloat(t.paddingBottom)):parseFloat(t.borderTopWidth)+parseFloat(t.borderBottomWidth),isNaN(f)&&(f=0),i()}function n(t){var n=e.style.width;e.style.width="0px",e.offsetWidth,e.style.width=n,c=t,u&&(e.style.overflowY=t),o()}function o(){var t=window.pageYOffset,n=document.body.scrollTop,o=e.style.height;e.style.height="auto";var i=e.scrollHeight+f;return 0===e.scrollHeight?void(e.style.height=o):(e.style.height=i+"px",v=e.clientWidth,document.documentElement.scrollTop=t,void(document.body.scrollTop=n))}function i(){var t=e.style.height;o();var i=window.getComputedStyle(e,null);if(i.height!==e.style.height?"visible"!==c&&n("visible"):"hidden"!==c&&n("hidden"),t!==e.style.height){var r=document.createEvent("Event");r.initEvent("autosize:resized",!0,!1),e.dispatchEvent(r)}}var d=void 0===arguments[1]?{}:arguments[1],s=d.setOverflowX,l=void 0===s?!0:s,a=d.setOverflowY,u=void 0===a?!0:a;if(e&&e.nodeName&&"TEXTAREA"===e.nodeName&&!r.has(e)){var f=null,c=null,v=e.clientWidth,p=function(){e.clientWidth!==v&&i()},h=function(t){window.removeEventListener("resize",p,!1),e.removeEventListener("input",i,!1),e.removeEventListener("keyup",i,!1),e.removeEventListener("autosize:destroy",h,!1),e.removeEventListener("autosize:update",i,!1),r["delete"](e),Object.keys(t).forEach(function(n){e.style[n]=t[n]})}.bind(e,{height:e.style.height,resize:e.style.resize,overflowY:e.style.overflowY,overflowX:e.style.overflowX,wordWrap:e.style.wordWrap});e.addEventListener("autosize:destroy",h,!1),"onpropertychange"in e&&"oninput"in e&&e.addEventListener("keyup",i,!1),window.addEventListener("resize",p,!1),e.addEventListener("input",i,!1),e.addEventListener("autosize:update",i,!1),r.add(e),l&&(e.style.overflowX="hidden",e.style.wordWrap="break-word"),t()}}function o(e){if(e&&e.nodeName&&"TEXTAREA"===e.nodeName){var t=document.createEvent("Event");t.initEvent("autosize:destroy",!0,!1),e.dispatchEvent(t)}}function i(e){if(e&&e.nodeName&&"TEXTAREA"===e.nodeName){var t=document.createEvent("Event");t.initEvent("autosize:update",!0,!1),e.dispatchEvent(t)}}var r="function"==typeof Set?new Set:function(){var e=[];return{has:function(t){return Boolean(e.indexOf(t)>-1)},add:function(t){e.push(t)},"delete":function(t){e.splice(e.indexOf(t),1)}}}(),d=null;"undefined"==typeof window||"function"!=typeof window.getComputedStyle?(d=function(e){return e},d.destroy=function(e){return e},d.update=function(e){return e}):(d=function(e,t){return e&&Array.prototype.forEach.call(e.length?e:[e],function(e){return n(e,t)}),e},d.destroy=function(e){return e&&Array.prototype.forEach.call(e.length?e:[e],o),e},d.update=function(e){return e&&Array.prototype.forEach.call(e.length?e:[e],i),e}),t.exports=d});

function translate(e){var t=new RegExp(/(__MSG_)[^<]*(_)/g);return e.match(t)?e.replace(t,function(e){var t=e.substring(0,e.length-1).replace("__MSG_",""),n=window.navigator.language;return dic[n]?dic[n][t]?dic[n][t].message:"undefined":dic.en[t]?dic.en[t].message:"undefined"}):void 0}function additionalLink(e,t,n){var i=document.createElement("a");return i.setAttribute("href",e.getAttribute("href")),n?(i.setAttribute("class","on-navigate next-up next-part bw_bottom_links"),i.innerHTML=translate('<span style="font-size:16px;" aria-hidden="true" class="fa fa-left fa-wp-darkgrey next-up-icon pull-left"></span><div class="next-up-title"><div>__MSG_contentPrevChapter_</div><h6>'+previouslink.children[0].innerHTML+"</h6></div>")):(i.setAttribute("class","on-navigate next-up next-part bw_links bw_links_"+t),i.innerHTML='<span style="font-size:16px;" aria-hidden="true" class="fa fa-'+t+" fa-wp-darkgrey next-up-icon pull-"+t+'"></span><div class="next-up-title">'+e.innerHTML+"</div>"),i}function profil_contoller(){bw_ENABLE_BROADCAT_AUTO&&document.getElementById("profile-messages")&&new MutationObserver(function(e,t){var n=document.querySelectorAll(".broadcast-checkbox");n.length>0&&(t.disconnect(),n[0].setAttribute("checked",!0))}).observe(document.getElementById("profile-messages"),{childList:!0,subtree:!0}),bw_ENABLE_COMMENT_IN_BIG&&document.getElementById("profile-messages")&&(launch_autoresize_mo("profile-messages","#profile-messages textarea"),launch_autoresize_mo_dynamic("#profile-messages .activity-feed div.collection","#profile-messages textarea"))}function selection_enabled(){for(var e=document.getElementsByClassName("panel-reading"),t=0;t<e.length;t++)e[t].style.MozUserSelect="text",e[t].style.WebkitUserSelect="text",e[t].style.MsUserSelect="text"}function autolink(){for(var e=/[-a-zA-Z0-9@:%_\+.~#?&\/\/=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&\/\/=]*)?/gi,t=/href="([^\'\"]+)/gi,n=/src="([^\'\"]+)/gi,i=document.getElementsByClassName("panel-reading"),o=0;o<i.length;o++)if("HEADER"!=i[o].nodeName&&"FOOTER"!=i[o].nodeName){var a=bw_countLink(i[o].innerHTML,e);a>0&&a>bw_countLink(i[o].innerHTML,t)+bw_countLink(i[o].innerHTML,n)&&(i[o].innerHTML=bw_urlify(i[o].innerHTML,e))}}function local_storage_remove_button(e,t,n){if(!document.getElementById("wb_reload_button")){var i=document.createElement("button");i.setAttribute("id","wb_reload_button"),i.setAttribute("class","btn"),i.innerHTML=translate("__MSG_"+n+"_");var o=document.getElementById(e);o.insertBefore(i,o.childNodes[0]),i.addEventListener("click",function(e){local_storage_remove(t),window.location.reload()})}}function local_storage_remove(e){for(var t=0,n=localStorage.length;n>t;++t)null!=localStorage.getItem(localStorage.key(t))&&localStorage.key(t).indexOf(e)>-1&&localStorage.removeItem(localStorage.key(t))}function launch_autoresize_mo(e,t){new MutationObserver(function(e,n){autosize(document.querySelectorAll(t)),n.disconnect()}).observe(document.getElementById(e),{childList:!0,subtree:!0})}function launch_autoresize_mo_dynamic(e,t){var n=document.querySelectorAll(e);if(n.length>0)for(var i=0;i<n.length;i++)new MutationObserver(function(e,n){autosize(document.querySelectorAll(t))}).observe(n[i],{childList:!0})}function bw_is_listened_mutation(e,t,n){var t=t?t:"HTML BODY",n=n?n:"advertisement skyscraper";return e.target.className.indexOf(n)>-1?!0:t.indexOf(e.target.nodeName)>-1?!0:!1}function bw_addStyleOnHead(e,t){var n=document.createElement("style"),i=document.createTextNode(t);n.setAttribute("id",e),n.appendChild(i),document.getElementsByTagName("head")[0].appendChild(n)}function bw_hasClass(e,t){return(" "+e.className+" ").indexOf(" "+t+" ")>-1}function bw_countLink(e,t){var n=new RegExp(t);return e.match(n)?e.match(n).length:0}function bw_urlify(e,t){var n=new RegExp(t);return e.match(n)?e.replace(n,function(e){var t=new RegExp(/\.(?:jpe?g|gif|png)$/);if(e.match(t)){var n=document.getElementsByClassName("panel-reading"),i=n[0].offsetWidth-20;return'<div style="display:block;width:100%;height:auto;padding-top:5px;padding-bottom:5px;"><img src="'+e+'" style="max-width='+i+';max-height=400"></div>'}return"<a target='_blank' href='"+e+"'>"+e+"</a>"}):e}var dic={en:{contentRemoveNotificationStorage:{message:"Load new notifications"},contentRemoveCommentsStorage:{message:"Load new comments"},contentPrevChapter:{message:"Back to previous chapter"}},fr:{contentRemoveNotificationsStorage:{message:"Charger les nouvelles notifications"},contentRemoveCommentsStorage:{message:"Charger les nouveaux commentaires"},contentPrevChapter:{message:"Relir le chapitre précédent"}}};bw_ENABLE_LOCAL_STORAGE_GESTION&&bw_addStyleOnHead("wem_storagegestion","#wb_reload_button{margin-bottom:10px; background:#F89B33;color:#fff}"),bw_ENABLE_ADDITIONNAL_LINK&&bw_addStyleOnHead("wem_additionallinks","#topFictionNavigation{border-top:1px solid #ededed;border-bottom:1px solid #ededed;display:block;font-size:14px;font-weight:600;color:#717171;line-height:24px;height:50px;width:93%;margin:auto;position:relative}.part-title{margin-bottom:10px}#topFictionNavigation .bw_links{position:absolute;display:flex;width:auto;color:#717171;top:10px}div.meta{border-bottom:none!important}.bw_links .fa-right{position:absolute;right:0;top:4px}.bw_links .fa-left{position:absolute;left:0;top:4px}.bw_links_left .next-up-title{text-align:left!important;margin-left:20px}.bw_bottom_links,.bw_links_right{text-align:right}.bw_links_right .next-up-title{margin-right:20px}.bw_links_right{border-top:none!important;right:0}.bw_links_left{left:0}.bw_bottom_links .next-up-title{text-align:right;width:97%}");var bw_is_fiction_page=!1,bw_ignore_event=!1,bw_is_notif_page=!1,bw_is_profil_page=!1,previouslink=!1,nextlink=!1,better_wattpad_init=function(e,t){e.forEach(function(e){bw_listen_mutation=bw_is_listened_mutation(e),bw_is_fiction_page=bw_hasClass(document.getElementsByTagName("body")[0],"route-storyReading"),bw_is_profil_page=bw_hasClass(document.getElementsByTagName("body")[0],"route-userProfile"),bw_is_notif_page=bw_hasClass(document.getElementsByTagName("body")[0],"route-notifications")});for(var n=document.querySelectorAll("#profile-dropdown li a"),i=0;i<n.length;i++)"/notifications"==n[i].getAttribute("href")&&n[i].addEventListener("click",function(){local_storage_remove("notifications")});bw_ENABLE_LOCAL_STORAGE_GESTION&&bw_is_notif_page&&local_storage_remove("notifications"),bw_listen_mutation&&bw_is_fiction_page&&new MutationObserver(function(e,t){if(e.forEach(function(e){bw_listen_mutation2=bw_is_listened_mutation(e,"DIV","post-comment")}),bw_listen_mutation2&&document.getElementById("story-reading")){if(t.disconnect(),bw_ENABLE_ADDITIONNAL_LINK){var n=document.querySelectorAll("header.panel-reading a.next-part");if(0==n.length){var i=document.querySelectorAll("#funbar-story ul.table-of-contents li"),o=document.querySelectorAll("header.panel-reading");o=o[0];var a=document.querySelectorAll("#footer .next-part");a=a[0];for(var r=0;r<i.length;r++)"active"==i[r].className&&(previouslink=i[r-1]?i[r-1]:!1,nextlink=i[r+1]?i[r+1]:!1);if(previouslink||nextlink){var l=document.createElement("div");l.setAttribute("id","topFictionNavigation"),o.appendChild(l)}if(previouslink){var s=additionalLink(previouslink.children[0],"left"),c=additionalLink(previouslink.children[0],"right",!0);l.appendChild(s),document.getElementById("footer").insertBefore(c,a)}if(nextlink){var d=additionalLink(nextlink.children[0],"right");l.appendChild(d)}}}if(bw_ENABLE_SELECT&&selection_enabled(),bw_ENABLE_AUTO_LINK&&autolink(),bw_ENABLE_JUSTIFY&&!document.getElementById("wem_justify")&&bw_addStyleOnHead("wem_justify","#story-reading .page p {text-align:justify}"),bw_INDENT>0&&!document.getElementById("wem_indent")&&bw_addStyleOnHead("wem_indent","#story-reading .page p {text-indent:"+bw_INDENT+"em!important;}"),bw_ENABLE_COMMENT_IN_BIG&&document.getElementById("comments")){launch_autoresize_mo("comments","#comments textarea");var _=document.querySelectorAll(".replies-list");if(_.length>0)for(var u=0;u<_.length;u++)new MutationObserver(function(e,t){bw_hasClass(e[0].target,"in")&&launch_autoresize_mo("comments","#comments textarea")}).observe(_[u],{attributes:!0,childList:!0,attributeFilter:["class"]})}bw_ENABLE_LOCAL_STORAGE_GESTION&&local_storage_remove_button("comments","comments","contentRemoveCommentsStorage");for(var m=document.querySelectorAll("div.part-content"),g=0;g<m.length;g++)m[g]&&new MutationObserver(function(){bw_ENABLE_SELECT&&selection_enabled(),bw_ENABLE_AUTO_LINK&&autolink()}).observe(m[g],{childList:!0})}}).observe(document.body,{attributes:!0,childList:!0,subtree:!0,attributeFilter:["class"]}),bw_is_profil_page&&(profil_contoller(),new MutationObserver(function(e,t){profil_contoller()}).observe(document.getElementById("content"),{attributes:!0,childList:!0,attributeFilter:["class"]})),bw_ENABLE_COMMENT_IN_BIG&&document.getElementById("commentform")&&launch_autoresize_mo("commentform","#commentform textarea")};window.location.href.indexOf("www.wattpad.com")>-1&&new MutationObserver(better_wattpad_init).observe(document.body,{attributes:!0,childList:!0,attributeFilter:["class"]});