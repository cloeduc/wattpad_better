// ==UserScript==
// @name         Better WattPad
// @namespace    http://cestdoncvrai.fr/
// @version      2
// @author       Alinoee
// @match        https://www.wattpad.com/*
// @include       *
// @require      http://cestdoncvrai.fr/wp-content/uploads/2016/08/wattpad_better.libs_.js
// @grant        none
// ==/UserScript==

/*
  START CONFIGURATION
  */

  var ff_wp_better_config = {
  wattpad_enable_justify:true, // true -> justifie text on fiction // false -> default comportment
  wattpad_enable_select:true, // true -> enable selection on fiction // false -> default comportment
  wattpad_enable_big_comment:true, // true -> auto-resize comment and other text fields // false -> default comportment (use scroll bar)
  wattpad_enable_links:true, // true -> make all links on fiction clikable // false -> default comportment
  wattpad_enable_alinea:0, // 0 : no indentation (default comportement) // 1 : 1em indentation // 2 : 2em indentation ...etc.
  wattpad_enable_auto_broadcast:true, // true -> check "notify my user" // false -> default comportment
  wattpad_enable_local_storage_gestion:true,  // true display button to update notifications // false -> no button... no notifications !
  wattpad_enable_additional_links:true,  // true display some additionals links to navigate on fiction
  wattpad_enable_paragraphe_comments:true
};
var wpb_translations={en:{contentRemoveNotificationStorage:{message:"Load new notifications"},contentRemoveCommentsStorage:{message:"Load new comments"},contentPrevChapter:{message:"Back to previous chapter"}},fr:{contentRemoveNotificationsStorage:{message:"Charger les nouvelles notifications"},contentRemoveCommentsStorage:{message:"Charger les nouveaux commentaires"},contentPrevChapter:{message:"Relire le chapitre précédent"}}},wp_better_config={configKeys:["wattpad_enable_select","wattpad_enable_justify","wattpad_enable_big_comment","wattpad_enable_alinea","wattpad_enable_auto_broadcast","wattpad_enable_local_storage_gestion","wattpad_enable_additional_links","wattpad_enable_paragraphe_comments","wattpad_enable_links"],getConfiguration:function(){navigator.sayswho.indexOf("Chrome")>-1?chrome.storage.sync.get(this.configKeys,function(a){wp_better_config=a}):navigator.sayswho.indexOf("Firefox")>-1&&(wp_better_config=ff_wp_better_config)}};$(document).ready(function(){wp_better_config.wattpad_enable_select&&wp_better.selection_enabled(),wp_better.initApp(),$("#app-container").observe("childlist",function(a){wp_better.initApp()}),navigator.sayswho.indexOf("Firefox")>-1&&wp_better.greaseMonkeyInitiation()});var wp_better={initApp:function(){if(wp_better.launch_complentary_observers(),$("body").hasClass("route-storyReading")){if(wp_better_config.wattpad_enable_select&&(wp_better.selection_enabled(),$("#parts-container-new").observe("childlist subtree","pre",function(a){wp_better.selection_enabled(),$("#parts-container-new").disconnect()})),wp_better_config.wattpad_enable_paragraphe_comments&&_.isUndefined($("#load_underline_comments")[0])){var a=$($("#parts-container-new article.story-part")[0]).attr("data-part-id");wp_better.add_interline_comments_button("https://api.wattpad.com/v4/parts/"+a+"/comments")}wp_better_config.wattpad_enable_big_comment&&wp_better.autoresize("#comments textarea"),wp_better_config.wattpad_enable_local_storage_gestion&&wp_better.add_reload_comment_button(),wp_better_config.wattpad_enable_justify&&_.isUndefined($(".wem_justify")[0])&&wp_better.addStyleOnHead("wem_justify","#story-reading .page p {text-align:justify}"),wp_better_config.wattpad_enable_alinea>0&&_.isUndefined($(".wem_wattpad_enable_alinea")[0])&&wp_better.addStyleOnHead("wem_wattpad_enable_alinea","#story-reading .page p {text-wattpad_enable_alinea:"+wp_better_config.wattpad_enable_alinea+"em!important;}"),wp_better_config.wattpad_enable_links&&wp_better.autolink($(".panel-reading p")),wp_better_config.wattpad_enable_additional_links&&wp_better.buttons_generation()}($("body").hasClass("route-userProfile")||window.location.href.indexOf("/user/cestdoncvrai/activity")>-1)&&(wp_better.add_profil_interraction(),$("#content").observe("childlist",function(a){$("#profile-messages").observe("childlist subtree",function(a){wp_better.add_profil_interraction(),$("#profile-messages").disconnect()})})),$("body").hasClass("route-notifications")&&wp_better_config.wattpad_enable_local_storage_gestion&&wp_better.cleanLocalStorage("notifications"),window.location.href.indexOf("www.wattpad.com/user_inbox")>-1&&wp_better.autoresize("textarea#comment")},launch_complentary_observers:function(){$("#comments").observe("childlist subtree",".message",function(a){wp_better_config.wattpad_enable_big_comment&&wp_better.autoresize("#comments textarea"),wp_better_config.wattpad_enable_local_storage_gestion&&wp_better.add_reload_comment_button()})},add_profil_interraction:function(a){if(wp_better_config.wattpad_enable_big_comment&&(wp_better.autoresize(".message textarea"),$("#profile-messages .collection").observe("childlist",function(a){wp_better.autoresize(".message textarea")})),wp_better_config.wattpad_enable_auto_broadcast){var b=$(".broadcast-checkbox");b.length>0&&b[0].setAttribute("checked",!0)}},add_reload_comment_button:function(){_.isUndefined($("#wb_reload_button")[0])&&($("#comments").prepend('<button id="wb_reload_button" class="btn">'+wp_better.translate("__MSG_contentRemoveCommentsStorage_")+"</button>"),$("#wb_reload_button").on("click",function(){wp_better.cleanLocalStorage("comments"),window.location.reload()}))},add_interline_comments_button:function(a){$.ajax({url:a,dataType:"json"}).done(function(a){if(!_.isUndefined(a.comments))for(c in a.comments)if(null!=a.comments[c].paragraphId)return _.isUndefined($("#load_underline_comments")[0])&&$("#comments").prepend('<button id="load_underline_comments" class="btn right">Placer les commentaires d\'interligne</button>'),$("#load_underline_comments").on("click",function(){if(!$(this).attr("isLoad")){var a=$($("#parts-container-new article.story-part")[0]).attr("data-part-id");wp_better.add_interline_comments("https://api.wattpad.com/v4/parts/"+a+"/comments"),$(this).attr("isLoad",!0),$(this).hide()}}),!0;_.isUndefined(a.nextUrl)||wp_better.add_interline_comments_button(a.nextUrl)})},add_interline_comments:function(a){$.ajax({url:a,dataType:"json"}).done(function(a){if(!_.isUndefined(a.comments)){for(c in a.comments)if(null!=a.comments[c].paragraphId){var b=a.comments[c],d=$("p[data-p-id="+b.paragraphId+"]").html(),e='<span class="bw_overline">',f='<span style="font-size:10px;" aria-hidden="true" class="fa fa-circle-filled fa-wp-grey bw_comment_marker"></span><span class="bw_comment_contenair">',g='<span class="bw_comment_on_text"><strong>'+b.author.name.strip_html()+" : </strong>"+b.body.strip_html()+"</span>",h="</span></span>";if(!_.isUndefined(d)){if(d.indexOf('<span class="bw_overline">')>-1){var i=d.indexOf('<span class="bw_comment_contenair">')+'<span class="bw_comment_contenair">'.length;d=d.insertAt(i,g)}else d.indexOf("data-media-type")>-1?d.prepend(e+f+g+h):d.indexOf("<b>")>-1||d.indexOf("<br")>-1||d.indexOf("<img")>-1?d=e+d+f+g+h:(d=d.insertAt(b.startPosition,e),d=d.insertAt(b.endPosition,f+g+h));$("p[data-p-id="+b.paragraphId.strip_html()+"]").html(d)}}$("span.bw_comment_marker").off("click").on("click",function(a){a.preventDefault(),$(this).parent().find("span.bw_comment_contenair").toggle(),$(this).parent().toggleClass("bw_overline_hover")})}_.isUndefined(a.nextUrl)||wp_better.add_interline_comments(a.nextUrl)})},buttons_generation:function(){var a=$("#funbar-story li.active").prev().children("a:first").attr("href"),b=$("#funbar-story li.active").prev().children("a:first").html(),c=$("#funbar-story li.active").next().children("a:first").attr("href"),d=$("#funbar-story li.active").next().children("a:first").html(),e="<div id='topFictionNavigation' class='navigationOnFiction'>";if(_.isUndefined(b)||(e=e+"<a href='"+a+"' class='on-navigate bw_links bw_links_left'><span style='font-size:16px;' aria-hidden='true' class='fa fa-left fa-wp-darkgrey next-up-icon pull-left'></span><div class='next-up-title'><span>"+b+"</span></div></a>"),_.isUndefined(d)||(e=e+"<a href='"+c+"' class='on-navigate bw_links bw_links_right'><span style='font-size:16px;' aria-hidden='true' class='fa fa-right fa-wp-darkgrey next-up-icon pull-right'></span><div class='next-up-title'><span>"+d+"</span></div></a>"),e+="</div>",!_.isUndefined(a))var f='<a class="on-navigate" href="'+a+'"><div class="orange bw_links_grey"><div class="next-up prev-part"><span>'+wp_better.translate("__MSG_contentPrevChapter_")+'</span><span class="fa fa-left fa-wp-white prev-up-icon" aria-hidden="true" style="font-size:16px;"></span></div></div></a>';_.isUndefined($(".prev-up-icon")[0])&&$($(".part-navigation")[0]).append(f),_.isUndefined($("#topFictionNavigation")[0])&&$($("header.panel-reading")[0]).append(e)},greaseMonkeyInitiation:function(){this.addStyleOnHead("ff","#wb_reload_button{margin-bottom:10px;background:#F89B33;color:#fff}.navigationOnFiction{border-top:1px solid #ededed;border-bottom:1px solid #ededed;display:block;font-size:14px;font-weight:600;color:#717171;line-height:24px;height:50px;width:93%;margin:auto;position:relative}.navigationOnFiction .bw_links span{color:#717171;font-size:14px;padding-top:0}.part-title{margin-bottom:10px}.navigationOnFiction .bw_links{position:absolute;display:flex;width:auto;color:#717171;top:10px}div.meta{border-bottom:none!important}.bw_links .fa-right{position:absolute;right:0;top:4px}.bw_links .fa-left{position:absolute;left:0;top:4px}.bw_links_left .next-up-title{text-align:left!important;margin-left:20px}.bw_bottom_links,.bw_links_right{text-align:right}.bw_links_right .next-up-title{margin-right:20px}.bw_links_right{border-top:none!important;right:0}#story-reading #parts-container-new footer .orange.bw_links_grey{color:#444!important;background-color:#DDD;border-color:#DDD}.bw_links_left{left:0}.bw_bottom_links .next-up-title{text-align:right;width:97%}.prev-up-icon{position:absolute;left:-14px;top:16px}.bw_comment_contenair,.bw_comment_marker{position:absolute;left:100%;line-height:15px}.next-up-icon{right:-14px}.part-navigation .orange{margin-bottom:5px}.bw_comment_contenair{font-size:.8em;color:grey;font-style:italic;width:50%;padding-left:30px;display:none}.bw_overline_hover{background-color:#eee}.bw_comment_marker{cursor:pointer;padding-left:15px;z-index:100}.bw_comment_on_text{display:block}")},selection_enabled:function(){$(".page").bind("contextmenu",function(a){a.stopPropagation()});for(var a=$(".panel-reading"),b=0;b<a.length;b++)a[b].style.MozUserSelect="text",a[b].style.WebkitUserSelect="text",a[b].style.MsUserSelect="text"},autoresize:function(a){autosize($(a))},addStyleOnHead:function(a,b){var c=document.createElement("style"),d=document.createTextNode(b);c.setAttribute("id",a),c.appendChild(d),document.getElementsByTagName("head")[0].appendChild(c)},cleanLocalStorage:function(a){for(var b=0,c=localStorage.length;b<c;++b)null!=localStorage.getItem(localStorage.key(b))&&localStorage.key(b).indexOf(a)>-1&&localStorage.removeItem(localStorage.key(b))},autolink:function(a){var b=/[-a-zA-Z0-9@:%_\+.~#?&\/\/=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&\/\/=]*)?/gi;a.each(function(){"header"!=$(this).prop("tagName")&&"footer"!=$(this).prop("tagName")&&$(this).html(wp_better.urlify($(this).html(),b))})},urlify:function(a,b){var c=new RegExp(b);if(a.match(c)){var d=/href="([^\'\"]+)/gi,e=/src="([^\'\"]+)/gi;if(!a.match(d)&&!a.match(e))return a.replace(c,function(a){return"<a target='_blank' href='"+a+"'>"+a+"</a>"})}return a},translate:function(a){var b=new RegExp(/(__MSG_)[^<]*(_)/g);return navigator.sayswho.indexOf("Chrome")>-1?a.match(b)?a.replace(b,function(a){var b=a.substring(0,a.length-1).replace("__MSG_","");return chrome.i18n.getMessage(b)?chrome.i18n.getMessage(b):"Error on translation data (WattPad Better Plugin). Please reload the page and contact plugin author if this bug persist"}):a:navigator.sayswho.indexOf("Firefox")>-1&&!_.isUndefined(wpb_translations)&&a.match(b)?a.replace(b,function(a){var b=a.substring(0,a.length-1).replace("__MSG_",""),c=window.navigator.language;return wpb_translations[c]?wpb_translations[c][b]?wpb_translations[c][b].message:"undefined":wpb_translations.en[b]?wpb_translations.en[b].message:"undefined"}):void 0}};String.prototype.insertAt=function(a,b){return this.substr(0,a)+b+this.substr(a)},String.prototype.strip_html=function(){return this.replace(/(<([^>]+)>)/gi,"")},navigator.sayswho=function(){var b,a=navigator.userAgent,c=a.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(c[1])?(b=/\brv[ :]+(\d+)/g.exec(a)||[],"IE "+(b[1]||"")):"Chrome"===c[1]&&(b=a.match(/\b(OPR|Edge)\/(\d+)/),null!=b)?b.slice(1).join(" ").replace("OPR","Opera"):(c=c[2]?[c[1],c[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(b=a.match(/version\/(\d+)/i))&&c.splice(1,1,b[1]),c.join(" "))}(),$.extend(wp_better_config),$.extend(wp_better),wp_better_config.getConfiguration();